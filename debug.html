<!DOCTYPE html>
<html>

<head>
    <title>Debug Camera Feed</title>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
        }

        #container {
            display: flex;
            gap: 10px;
            padding: 10px;
            flex-wrap: wrap;
        }

        canvas,
        video {
            border: 2px solid #fff;
        }

        .label {
            font-size: 12px;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <div id="container">
        <div>
            <div class="label">Video Element</div>
            <video class="input_video" width="320" height="180" playsinline autoplay></video>
        </div>
        <div>
            <div class="label">Video Canvas (Mirrored)</div>
            <canvas id="videoCanvas" width="320" height="180"></canvas>
        </div>
        <div>
            <div class="label">Mask Canvas (Mirrored)</div>
            <canvas id="maskCanvas" width="320" height="180"></canvas>
        </div>
        <div>
            <div class="label">Smooth Canvas</div>
            <canvas id="smoothCanvas" width="320" height="180"></canvas>
        </div>
    </div>
    <div id="status" style="padding: 10px;">Loading...</div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

    <script>
        const videoElement = document.querySelector('.input_video');
        const videoCanvas = document.getElementById('videoCanvas');
        const maskCanvas = document.getElementById('maskCanvas');
        const smoothCanvas = document.getElementById('smoothCanvas');
        const statusDiv = document.getElementById('status');

        const videoCtx = videoCanvas.getContext('2d');
        const maskCtx = maskCanvas.getContext('2d');
        const smoothCtx = smoothCanvas.getContext('2d');

        let isFirstFrame = true;
        const MASK_SMOOTHING_ALPHA = 0.35;
        const MASK_BLUR_PX = 3;

        function onResults(results) {
            // Draw mirrored video
            videoCtx.save();
            videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
            videoCtx.translate(videoCanvas.width, 0);
            videoCtx.scale(-1, 1);
            videoCtx.drawImage(results.image, 0, 0, videoCanvas.width, videoCanvas.height);
            videoCtx.restore();

            // Process mask with smoothing
            if (isFirstFrame) {
                smoothCtx.drawImage(results.segmentationMask, 0, 0, smoothCanvas.width, smoothCanvas.height);
                isFirstFrame = false;
            } else {
                smoothCtx.globalCompositeOperation = 'source-over';
                smoothCtx.globalAlpha = MASK_SMOOTHING_ALPHA;
                smoothCtx.drawImage(results.segmentationMask, 0, 0, smoothCanvas.width, smoothCanvas.height);
                smoothCtx.globalAlpha = 1.0;
            }

            // Draw mirrored mask with blur
            maskCtx.save();
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            maskCtx.translate(maskCanvas.width, 0);
            maskCtx.scale(-1, 1);
            maskCtx.filter = `blur(${MASK_BLUR_PX}px)`;
            maskCtx.drawImage(smoothCanvas, 0, 0, maskCanvas.width, maskCanvas.height);
            maskCtx.filter = 'none';
            maskCtx.restore();

            statusDiv.innerText = 'Tracking Active';
        }

        const selfieSegmentation = new SelfieSegmentation({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
        });
        selfieSegmentation.setOptions({ modelSelection: 1, selfieMode: false });
        selfieSegmentation.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await selfieSegmentation.send({ image: videoElement }); },
            width: 1280,
            height: 720
        });
        camera.start();
    </script>
</body>

</html>